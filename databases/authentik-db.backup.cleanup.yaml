apiVersion: v1
kind: PersistentVolume
metadata:
  name: authentik-backup-pv
spec:
  capacity:
    storage: 10Ti
  accessModes: [ReadWriteMany]
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: nfs.csi.k8s.io
    volumeHandle: authentik-nas-backup-share
    volumeAttributes:
      server: 172.16.10.2
      share: /volume1/backup
  mountOptions:
    # - nfsvers=4.1
    - hard
    - noac
    - timeo=600
    - retrans=2
    - noatime
    - tcp
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: authentik-backup-pvc
  namespace: authentik
spec:
  accessModes: [ReadWriteMany]
  resources:
    requests:
      storage: 10Ti
  volumeName: authentik-backup-pv
  storageClassName: ""
---
# This CronJob runs weekly to clean up old PostgreSQL backup files 
# from the NFS share, enforcing a 30-day retention policy.

apiVersion: batch/v1
kind: CronJob
metadata:
  name: weekly-postgres-authentik-backup-cleanup
  namespace: authentik
spec:
  # Schedule: Run every Sunday at 03:00 AM UTC (after the backup runs at 02:00 AM)
  schedule: "0 5 * * SUN"
  concurrencyPolicy: Forbid # Ensures only one cleanup job runs at a time
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup-cleanup-runner
            # Use a minimal image with the 'find' utility (like busybox or alpine)
            image: busybox:latest
            imagePullPolicy: Always
            
            # Volume Mount: Mount the same PVC as the backup job
            volumeMounts:
            - name: backup-storage
              mountPath: "/mnt/nfs-backup"

            # Command: The core cleanup script
            command: ["/bin/sh", "-c"]
            args:
              - |
                BACKUP_DIR="/mnt/nfs-backup"
                RETENTION_DAYS="30"
                
                echo "Starting cleanup of backups in ${BACKUP_DIR} older than ${RETENTION_DAYS} days."
                
                # Check if the directory exists and is accessible
                if [ ! -d "${BACKUP_DIR}" ]; then
                  echo "ERROR: Backup directory ${BACKUP_DIR} does not exist or is not mounted!"
                  exit 1
                fi
                
                # The 'find' command searches for files in the backup directory:
                # 1. /mnt/nfs-backup - Starts search here.
                # 2. -type f - Only search for files (not directories).
                # 3. -name '*.dump.gz' - Ensures only compressed database dumps are targeted.
                # 4. -mtime +${RETENTION_DAYS} - Finds files modified more than 30 days ago.
                # 5. -delete - Executes the deletion command on found files.
                
                find "${BACKUP_DIR}" \
                  -type f \
                  -name '*.dump.gz' \
                  -mtime +${RETENTION_DAYS} \
                  -print \
                  -delete
                  
                echo "Cleanup complete. Deleted files older than ${RETENTION_DAYS} days."
          
          # Volume Definition: Reference the PVC created previously
          volumes:
          - name: backup-storage
            hostPath:
              path: "/mnt/ugreen-backup/authentik"
              type: DirectoryOrCreate
