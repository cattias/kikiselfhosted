apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kikiserver-critical-alerts
  namespace: monitoring
spec:
  groups:
  - name: kikiserver.alerts
    rules:
    - alert: KubePodCrashLooping
      expr: |
        count(kube_pod_container_status_restarts_total) by (pod, namespace) > 5
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crashlooping ({{ $value }} restarts).
        description: Check logs for application errors (e.g., config error, volume failure).

    - alert: KubePersistentVolumeFillingUp
      expr: |
        (kubelet_volume_stats_available_bytes{job="kubelet"} / kubelet_volume_stats_capacity_bytes{job="kubelet"} * 100) < 10 and kubelet_volume_stats_used_bytes{job="kubelet"} > 0
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: Persistent Volume {{ $labels.persistentvolumeclaim }} is filling up ({{ $value }}% remaining).
        description: PVC is running out of space. Check your NFS/Ceph capacity.

    - alert: CephManagerCrash
      # This checks for the mgr module crash warning you saw earlier
      expr: |
        sum(ceph_cluster_health_status_code{name="RECENT_MGR_MODULE_CRASH"}) > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: Ceph Manager Module Crash Detected
        description: The Ceph MGR module (management service) is crashing repeatedly. Immediate investigation required.
