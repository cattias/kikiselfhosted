apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kikiserver-critical-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: kikiserver.alerts
    rules:
    - alert: KubePodCrashLooping
      expr: |
        count(kube_pod_container_status_restarts_total) by (pod, namespace) > 5
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crashlooping ({{ $value }} restarts).
        description: Check logs for application errors (e.g., config error, volume failure).

    - alert: KubePersistentVolumeFillingUp
      expr: |
        (kubelet_volume_stats_available_bytes{job="kubelet"} / kubelet_volume_stats_capacity_bytes{job="kubelet"} * 100) < 10 and kubelet_volume_stats_used_bytes{job="kubelet"} > 0
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: Persistent Volume {{ $labels.persistentvolumeclaim }} is filling up ({{ $value }}% remaining).
        description: PVC is running out of space. Check your NFS/Ceph capacity.
