apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  syncPolicy:
    automated:
      enabled: true
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true 
      - ServerSideApply=true 
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  destination:
    namespace: documents
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: nextcloud
    repoURL: https://nextcloud.github.io/helm/
    targetRevision: 8.9.1
    helm:
      releaseName: nextcloud
      valuesObject:
        nextcloud:
          host: cloud.attias.io
          defaultConfigs:
            imaginary.config.php: true
          configs:
            proxy.config.php: |-
              <?php
              $CONFIG = array (
                'trusted_proxies' => array('10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'),
                'overwriteprotocol' => 'https',
                'overwrite.cli.url' => 'https://cloud.attias.io',
                'allow_local_remote_servers' => true,
              );
          ## Use an existing secret
          existingSecret:
            enabled: true
            secretName: nextcloud-secret
            usernameKey: username
            passwordKey: password
            tokenKey: ""
            smtpUsernameKey: smtp_username
            smtpPasswordKey: smtp_password
            smtpHostKey: smtp_host
          # if set, we'll template this list to the NEXTCLOUD_TRUSTED_DOMAINS env var
          trustedDomains: [cloud.attias.io, localhost, attias.io]
          ## SMTP configuration
          mail:
            enabled: true
            # the user we send email as
            fromAddress: cloud
            # the domain we send email from
            domain: attias.io
            smtp:
              secure: ssl
              port: 587
              authtype: LOGIN
          objectStore:
            # https://docs.nextcloud.com/server/latest/admin_manual/configuration_files/primary_storage.html#simple-storage-service-s3
            s3:
              enabled: true
              usePathStyle: true
              # use TLS/SSL for S3 connections
              ssl: false
              # default port that can be changed based on your object store, e.g. for minio, you can use 9000
              port: "80"
              # this is the default in the nextcloud docs
              region: "ceph-objectstore"
              # required if using s3, the name of the bucket you'd like to use
              bucket: "nextcloud"
              # object prefix in bucket
              prefix: "nextcloud"
              # use an existingSecret for S3 credentials. If set, we ignore the following under nextcloud.objectStore.s3
              # endpoint, accessKey, secretKey
              existingSecret: "nextcloud-secret"
              secretKeys:
                # key in nextcloud.objectStore.s3.existingSecret to use for s3 endpoint
                host: "s3-host"
                # key in nextcloud.objectStore.s3.existingSecret to use for s3 accessKeyID
                accessKey: "s3-accesskey"
                # key in nextcloud.objectStore.s3.existingSecret to use for s3 secretAccessKey
                secretKey: "s3-secretkey"
                # key in nextcloud.objectStore.s3.existingSecret to use for the s3 bucket
                bucket: "s3-bucket"
                # key in nextcloud.objectStore.s3.existingSecret to use for the s3 sse_c_key
                sse_c_key: ""
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: monitoring
            labels:
              release: kube-prometheus-stack
          rules:
            enabled: true
            labels:
              release: kube-prometheus-stack
        rbac:
          enabled: true
        internalDatabase:
          enabled: false
        externalDatabase:
          enabled: true
          type: postgresql
          existingSecret:
            enabled: true
            secretName: nextcloud-db-app
            usernameKey: username
            passwordKey: password
            hostKey: host
            databaseKey: dbname
        persistence:
          enabled: true
          existingClaim: nextcloud-data-pvc
        collabora:
          enabled: true
          collabora:
            existingSecret:
              # set to true to to get collabora admin credentials from an existin secret
              # if set, ignores collabora.collabora.username and password
              enabled: true
              # name of existing Kubernetes Secret with collboara admin credentials
              secretName: "nextcloud-secret"
              usernameKey: "username"
              passwordKey: "password"
        imaginary:
          enabled: true
        cronjob:
          enabled: true