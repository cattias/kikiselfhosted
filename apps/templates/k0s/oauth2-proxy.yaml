apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: oauth2-proxy
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/compare-options: ServerSideDiff=true
spec:
  syncPolicy:
    automated:
      enabled: true
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
  destination:
    namespace: kubernetes-dashboard
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: oauth2-proxy
    repoURL: https://oauth2-proxy.github.io/manifests
    targetRevision: 10.1.1
    helm:
      releaseName: oauth2-proxy
      valuesObject:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: monitoring
            labels:
              release: kube-prometheus-stack
        config:
          existingSecret: k0s-dashboard-secret
        extraArgs:
          provider: "oidc"
          oidc-issuer-url: "https://authentik.attias.io/application/o/k0s-server/"
          email-domain: "*"
          upstream: "http://kubernetes-dashboard-web.kubernetes-dashboard.svc.cluster.local:8000"
          pass-authorization-header: "true"
          set-authorization-header: "true"
          scope: "openid email profile"
          cookie-secure: "true"
          cookie-domain: ".attias.io"
          whitelist-domain: ".attias.io"
          # This helps skip the "Sign in with OpenID Connect" button on the proxy itself
          skip-provider-button: "true"