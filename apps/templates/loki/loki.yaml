apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/compare-options: ServerSideDiff=true
spec:
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      name: plex-plex-media-server
      jsonPointers:
      - /spec/template/metadata/creationTimestamp # Ignored for Pod Template
      - /metadata/creationTimestamp # Ignored for the StatefulSet itself
      - /spec/volumeClaimTemplates/0/metadata/creationTimestamp
  syncPolicy:
    automated:
      enabled: true
      prune: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: loki
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 6.46.0
    helm:
      releaseName: loki
      valuesObject:
        minio:
          enabled: true
        loki:
          ui:
            enabled: true
          auth_enabled: false
          storage:
            type: 'filesystem'
            storageClassName: ceph-block
            size: 100Gi
            accessModes:
              - ReadWriteOnce
            bucketNames:
              chunks: chunks
              ruler: ruler
              admin: admin
          query_scheduler:
            max_outstanding_requests_per_tenant: 2048
          readinessProbe:
            httpGet:
              path: /ready
              port: http-metrics
            initialDelaySeconds: 45
            timeoutSeconds: 5
          schemaConfig:
            configs:
              - from: "2024-04-01"
                store: tsdb
                object_store: s3
                schema: v13
                index:
                  prefix: loki_index_
                  period: 24h
          image:
            # -- The Docker registry
            registry: docker.io
            # -- Docker image repository
            repository: grafana/loki
            # -- Overrides the image tag whose default is the chart's appVersion
            # TODO: needed for 3rd target backend functionality
            # revert to null or latest once this behavior is relased
            tag: null
            # -- Docker image pull policy
            pullPolicy: IfNotPresent
          # -- Common annotations for all pods
          podAnnotations: {}
          # -- Common labels for all pods
          podLabels: {}
          # -- The number of old ReplicaSets to retain to allow rollback
          revisionHistoryLimit: 10
          # -- The SecurityContext for Loki pods
          podSecurityContext:
            fsGroup: 10001
            runAsGroup: 10001
            runAsNonRoot: true
            runAsUser: 10001
          # -- The SecurityContext for Loki containers
          containerSecurityContext:
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
            allowPrivilegeEscalation: false
          # -- Should enableServiceLinks be enabled. Default to enable
          enableServiceLinks: true
        
        deploymentMode: SingleBinary

        table_manager:
          retention_deletes_enabled: true
          #WARNING: The retention period must be a multiple of the index and chunks table period, configured in the period_config block. Which is 24h, so 4 weeks retention is 672h.
          retention_period: 672
        # look_back restriction that should be the same value as retention_period
        chunk_store_config:
          # max_look_back_period must be equal to retention_period
          max_look_back_period: 672
        # --------------------------------------------------------------------------
        # Configuration for the single binary node(s)
        singleBinary:
          replicas: 1
          persistence:
            # -- Enable StatefulSetAutoDeletePVC feature
            enableStatefulSetAutoDeletePVC: false
            # -- Enable persistent disk
            enabled: true
            # -- Size of persistent disk
            size: 100Gi
            # -- Storage class to be used.
            # If defined, storageClassName: <storageClass>.
            # If set to "-", storageClassName: "", which disables dynamic provisioning.
            # If empty or set to null, no storageClassName spec is
            # set, choosing the default provisioner (gp2 on AWS, standard on GKE, AWS, and OpenStack).
            storageClass: ceph-block
            # -- Selector for persistent disk
          selector: null
          # distributor:
          #   ring:
          #     kvstore:
          #       store: memberlist
          # ingester:
          #   lifecycler:
          #     ring:
          #       kvstore:
          #         store: memberlist
          #       replication_factor: 1
          #     final_sleep: 0s
          #     chunk_idle_period: 5m
          #     chunk_retain_period: 30s
          # extraEnv:
          #   - name: MY_POD_IP
          #     valueFrom:
          #       fieldRef:
          #         fieldPath: status.podIP
          # extraArgs:
          #   - -memberlist.bind-addr=$(MY_POD_IP)
        # memberlist:
        #   abort_if_cluster_join_fails: false
        #   # Expose this port on all distributor, ingester
        #   # and querier replicas.
        #   bind_port: 7946
        #   join_members:
        #   - loki-gossip-ring.loki.svc.cluster.local:7946
        
        gateway:
          enabled: false

        backend:
          replicas: 0
        read:
          replicas: 0
        write:
          replicas: 0

