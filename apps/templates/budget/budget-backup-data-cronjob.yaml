apiVersion: v1
kind: PersistentVolume
metadata:
  name: budget-backup-pv
spec:
  capacity:
    storage: 10Ti
  accessModes: [ReadWriteMany]
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: nfs.csi.k8s.io
    volumeHandle: budget-nas-backup-share
    volumeAttributes:
      server: 172.16.10.2
      share: /volume1/backup
  mountOptions:
    # - nfsvers=4.1
    - hard
    - noac
    - timeo=600
    - retrans=2
    - noatime
    - tcp
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: budget-backup-pvc
  namespace: budget
spec:
  accessModes: [ReadWriteMany]
  resources:
    requests:
      storage: 10Ti
  volumeName: budget-backup-pv
  storageClassName: ""
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: budget-data-backup
  namespace: budget
spec:
  # Schedule: Run every night at 03:00 AM (UTC)
  schedule: "15 1 * * *"
  # If the job fails, retry up to 1 time
  failedJobsHistoryLimit: 1
  # Keep 1 successful job history
  successfulJobsHistoryLimit: 1
  # Concurrency Policy: Prevents a new job from starting if the previous one is still running.
  concurrencyPolicy: Forbid 
  # The actual job template
  jobTemplate:
    spec:
      template:
        spec:
          # Use a Pod that is suitable for file operations
          containers:
            - name: rsync-backup
              # rsync is a standard tool for efficient, incremental backups
              image: instrumentisto/rsync-ssh:latest 
              imagePullPolicy: Always
              
              # The rsync command: 
              # -a: archive mode (preserves permissions, ownership, timestamps)
              # -v: verbose output
              # --delete: remove files from destination if they are removed from source (sync)
              # /mnt/source/ is used to copy the contents, not the folder itself
              command: ["/bin/sh", "-c"]
              args:
                - "echo 'Starting Actual Budget data backup...'; rsync -rltv --delete /mnt/source/ /mnt/destination/; echo 'Backup complete.'"

              volumeMounts:
                # 1. Source: Mealie's persistent data (Ceph)
                - name: budget-source-volume
                  mountPath: /mnt/source
                # 2. Destination: Backup PV (NFS)
                - name: backup-volume
                  mountPath: /mnt/destination
                  subPath: budget
          
          restartPolicy: OnFailure

          volumes:
            # 1. Source Volume (The data you want to backup)
            - name: budget-source-volume
              persistentVolumeClaim:
                claimName: budget-data-pvc
            # 2. Destination Volume (The NFS mount)
            - name: backup-volume
              persistentVolumeClaim:
                claimName: budget-backup-pvc