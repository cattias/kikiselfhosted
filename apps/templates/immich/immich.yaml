apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  syncPolicy:
    automated:
      prune: true
      enabled: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  destination:
    namespace: photos
    server: https://kubernetes.default.svc
  project: default
  source:
    repoURL: oci://ghcr.io/immich-app/immich-charts/immich
    targetRevision: 0.10.3
    chart: immich
    helm:
      valuesObject:
        controllers:
          main:
            containers:
              main:
                image:
                  tag: v2.3.1
                env:
                  - name: REDIS_HOSTNAME
                    value: immich-redis
                  - name: DB_URL
                    valueFrom:
                      secretKeyRef:
                        name: immich-db-app
                        key: uri
        immich:
          metrics:
            enabled: false
          persistence:
            library:
              existingClaim: immich-library-pvc
          configuration:
            trash:
              enabled: true
              days: 30
            storageTemplate:
              enabled: true
              template: '{{ "{{" }}y{{ "}}" }}/{{ "{{" }}y{{ "}}" }}-{{ "{{" }}MM{{ "}}" }}-{{ "{{" }}dd{{ "}}" }}/{{ "{{" }}filename{{ "}}" }}'
        persistence:
          cache:
            enabled: true
            size: 10Gi
            type: emptyDir
            accessMode: ReadWriteMany
            storageClass: ceph-block
        server:
          enabled: true
          labels:
            traefik.enable: true
            # increase readingTimeouts for the entrypoint used here
            traefik.http.routers.immich.entrypoints: websecure
            traefik.http.routers.immich.rule: Host(`photos.attias.io`)
            traefik.http.services.immich.loadbalancer.server.port: 2283
          service:
            main:
              type: LoadBalancer
        machine-learning:
          enabled: true
