apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  syncPolicy:
    automated:
      enabled: true
      prune: false
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts/
    targetRevision: 79.9.0
    helm:
      releaseName: kube-prometheus-stack
      valuesObject:
        grafana:
          enabled: false
        prometheus:
          prometheusSpec:
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: ceph-block
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 50Gi
        alertmanager:
          alertmanagerSpec:
            secrets:
              - telegram-bot-secret
          config:
            global:
              resolve_timeout: 5m
            inhibit_rules:
              - source_matchers:
                  - 'severity = critical'
                target_matchers:
                  - 'severity =~ warning|info'
                equal:
                  - 'namespace'
                  - 'alertname'
              - source_matchers:
                  - 'severity = warning'
                target_matchers:
                  - 'severity = info'
                equal:
                  - 'namespace'
                  - 'alertname'
              - source_matchers:
                  - 'alertname = InfoInhibitor'
                target_matchers:
                  - 'severity = info'
                equal:
                  - 'namespace'
              - target_matchers:
                  - 'alertname = InfoInhibitor'
            route:
              group_by: ['namespace']
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 1h
              receiver: 'telegram-alert'
              routes:
              - receiver: 'null'
                matchers:
                  - alertname = "Watchdog"
            receivers:
            - name: 'null'
            - name: 'telegram-alert'
              telegram_configs:
              - api_url: 'https://api.telegram.org'
                bot_token_file: '/etc/alertmanager/secrets/telegram-bot-secret/botid'
                chat_id: 76776913
                parse_mode: 'HTML'
                disable_notifications: false
                send_resolved: true
                message: '{{ template "telegram.message" .}}'
            templates:
            - '/etc/alertmanager/config/*.tmpl'
          templateFiles:
            telegram.tmpl: |-
              {{ define "telegram.message" }}
              <b>KikiServer</b>
              {{ .Alerts }}
              {{ .Status }}
              {{ .ExternalURL }}
              {{ .GroupLabels }}
              {{ .CommonLabels }}
              {{ .CommonAnnotations }}
              {{ if eq .Status "firing" }}
                  {{ if eq .CommonLabels.severity "critical" }}
                      üî¥ Alert: {{ .CommonLabels.alertname }}
                  {{ else if eq .CommonLabels.severity "warning" }}
                      üü† Alert: {{ .CommonLabels.alertname }}
                  {{ else }}
                      ‚ö™Ô∏è Alert: {{ .CommonLabels.alertname }}
                  {{ end }}
              Status: üî• FIRING
              Severity: {{ if eq .CommonLabels.severity "critical" }}üî¥ {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}üü† {{ .CommonLabels.severity | title }}{{ else }}‚ö™Ô∏è {{ .CommonLabels.severity | title }}{{ end }}
              {{ else if eq .Status "resolved" }}
                  ‚ö™Ô∏è Alert: {{ .CommonLabels.alertname }}
              Status: ‚úÖ RESOLVED
              Severity: {{ if eq .CommonLabels.severity "critical" }}üü¢ {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}üü¢ {{ .CommonLabels.severity | title }}{{ else }}‚ö™Ô∏è {{ .CommonLabels.severity | title }}{{ end }}
              {{ end }}

              {{ range .Alerts }}

              {{ if .Labels.job }}
              Job: `{{ .Labels.job }}`
              {{ end }}

              {{ if .Labels.namespace }}
              Namespace: `{{ .Labels.namespace }}`
              {{ end }}

              {{ if .Labels.instance }}
              Instance: `{{ .Labels.instance }}`
              {{ end }}

              {{ if .Annotations.runbook_url }}
              [RunbookURL]({{ .Annotations.runbook_url }})
              {{ end }}

              {{ end }}
              {{ end }}
