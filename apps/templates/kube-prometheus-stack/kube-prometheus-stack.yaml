apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  syncPolicy:
    automated:
      enabled: true
      prune: false
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts/
    targetRevision: 79.9.0
    helm:
      releaseName: kube-prometheus-stack
      valuesObject:
        grafana:
          enabled: false
        prometheus:
          prometheusSpec:
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: ceph-block
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 50Gi
        alertmanager:
          alertmanagerSpec:
            secrets:
              - telegram-bot-secret
          config:
            global:
              resolve_timeout: 5m
            inhibit_rules:
              - source_matchers:
                  - 'severity = critical'
                target_matchers:
                  - 'severity =~ warning|info'
                equal:
                  - 'namespace'
                  - 'alertname'
              - source_matchers:
                  - 'severity = warning'
                target_matchers:
                  - 'severity = info'
                equal:
                  - 'namespace'
                  - 'alertname'
              - source_matchers:
                  - 'alertname = InfoInhibitor'
                target_matchers:
                  - 'severity = info'
                equal:
                  - 'namespace'
              - target_matchers:
                  - 'alertname = InfoInhibitor'
            route:
              group_by: ['namespace']
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 1h
              receiver: 'telegram-alert'
              routes:
              - receiver: 'null'
                matchers:
                  - alertname = "Watchdog"
            receivers:
            - name: 'null'
            - name: 'telegram-alert'
              telegram_configs:
              - api_url: 'https://api.telegram.org'
                bot_token_file: '/etc/alertmanager/secrets/telegram-bot-secret/botid'
                chat_id: 76776913
                parse_mode: 'HTML'
                message: '{{ template "telegram.message". }}' 
            templates:
            - '/etc/alertmanager/config/*.tmpl'
          templateFiles:
            telegam.tmpl: |-
              {{ "{{" }} define "alert_list" {{ "}}" }}{{ "{{" {{ "}}" }} range . {{ "}}" }}
              ---
              ü™™ <b>{{ "{{" {{ "}}" }} .Labels.alertname {{ "}}" }} - Kikiserver</b>
              {{ "{{" {{ "}}" }}- if eq .Labels.severity "critical" {{ "}}" }}
              üö® CRITICAL üö® {{ "{{" {{ "}}" }} end {{ "}}" }}
              {{ "{{" {{ "}}" }}- if eq .Labels.severity "warning" {{ "}}" }}
              ‚ö†Ô∏è WARNING ‚ö†Ô∏è{{ "{{" {{ "}}" }} end {{ "}}" }}
              {{ "{{" {{ "}}" }}- if .Annotations.summary {{ "}}" }}
              üìù {{ "{{" {{ "}}" }} .Annotations.summary {{ "}}" }}{{ "{{" {{ "}}" }} end {{ "}}" }}
              {{ "{{" {{ "}}" }}- if .Annotations.description {{ "}}" }}
              üìñ {{ "{{" {{ "}}" }} .Annotations.description {{ "}}" }}{{ "{{" {{ "}}" }} end {{ "}}" }}

              üè∑ Labels:
              {{ "{{" {{ "}}" }} range .Labels.SortedPairs {{ "}}" }}  <i>{{ "{{" {{ "}}" }} .Name {{ "}}" }}</i>: <code>{{ "{{" {{ "}}" }} .Value {{ "}}" }}</code>
              {{ "{{" {{ "}}" }} end {{ "}}" }}{{ "{{" {{ "}}" }} end {{ "}}" }}
              üõ† <a href="https://obs.attias.io">Grafana</a> üíä <a href="https://alertmanager.attias.io">Alertmanager</a> üõ†
              {{ "{{" {{ "}}" }} end {{ "}}" }}

              {{ "{{" {{ "}}" }} define "telegram.message" {{ "}}" }}
              {{ "{{" {{ "}}" }} if gt (len .Alerts.Firing) 0 {{ "}}" }}
              üî• Alerts Firing üî•
              {{ "{{" {{ "}}" }} template "alert_list" .Alerts.Firing {{ "}}" }}
              {{ "{{" {{ "}}" }} end {{ "}}" }}
              {{ "{{" {{ "}}" }} if gt (len .Alerts.Resolved) 0 {{ "}}" }}
              ‚úÖ Alerts Resolved ‚úÖ
              {{ "{{" {{ "}}" }} template "alert_list" .Alerts.Resolved {{ "}}" }}
              {{ "{{" {{ "}}" }} end {{ "}}" }}
              {{ "{{" {{ "}}" }} end {{ "}}" }}
