# caddy
apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
chmod o+r /usr/share/keyrings/caddy-stable-archive-keyring.gpg
chmod o+r /etc/apt/sources.list.d/caddy-stable.list
apt update
apt install caddy
vi /etc/caddy/Caddyfile 
systemctl restart caddy

# unattented upgrades
apt install unattended-upgrades -y
dpkg-reconfigure -plow unattended-upgrades
vi /etc/apt/apt.conf.d/20auto-upgrades
vi /etc/apt/apt.conf.d/50unattended-upgrades

# crowdsec
curl -s https://install.crowdsec.net | sudo sh
apt upgrade
apt install crowdsec
apt install crowdsec-firewall-bouncer-iptables
cscli collections install crowdsecurity/caddy
vi /etc/crowdsec/acquis.yaml
vi /etc/ssh/sshd_config.d/kiki.conf
systemctl daemon-reload
systemctl restart ssh.socket

sudo cscli console enroll $ENROLLMENT_KEY
sudo systemctl restart crowdsec

# Firewall
ufw allow in on tailscale0
ufw deny 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 3478/udp
ufw allow 51820/udp
ufw enable
ufw reload

# glances
apt install pipx -y
pipx ensurepath
pipx install "glances[web]"
vi /usr/lib/systemd/system/glancesweb.service
systemctl daemon-reload
systemctl start glancesweb
systemctl enable glancesweb
# ss -antpl | grep glances

# headscale
HEADSCALE_VERSION="" # See above URL for latest version, e.g. "X.Y.Z" (NOTE: do not add the "v" prefix!)
HEADSCALE_ARCH="" # Your system architecture, e.g. "amd64"
wget --output-document=headscale.deb "https://github.com/juanfont/headscale/releases/download/v${HEADSCALE_VERSION}/headscale_${HEADSCALE_VERSION}_linux_${HEADSCALE_ARCH}.deb"
sudo apt install ./headscale.deb
sudo vi /etc/headscale/config.yaml
sudo systemctl enable --now headscale

echo "91.98.236.199 tailscale.attias.io" >> /etc/hosts

# tailscale
curl -fsSL https://tailscale.com/install.sh | sh
tailscale up --accept-dns --accept-routes --advertise-exit-node --login-server=http://localhost:8880 --ssh
tailscale set --auto-update=true

sudo vi /etc/systemd/system/tailscale-eth-tuning.service
# Reload systemd to see the new file
sudo systemctl daemon-reload
# Enable the service for future boots
sudo systemctl enable tailscale-eth-tuning.service
# Start it now to apply the settings immediately
sudo systemctl start tailscale-eth-tuning.service
# check
ethtool -k eth0 | grep -E "rx-udp-gro-forwarding|rx-gro-list"

# fail2ban
apt install fail2ban
systemctl enable --now fail2ban