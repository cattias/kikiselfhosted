apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: plex
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/compare-options: ServerSideDiff=true
spec:
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      name: plex-plex-media-server
      jsonPointers:
      - /spec/template/metadata/creationTimestamp # Ignored for Pod Template
      - /metadata/creationTimestamp # Ignored for the StatefulSet itself
      - /spec/volumeClaimTemplates/0/metadata/creationTimestamp
  syncPolicy:
    automated:
      prune: true
      enabled: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
  destination:
    namespace: plex
    server: https://kubernetes.default.svc
  project: default
  source:
    repoURL: https://raw.githubusercontent.com/plexinc/pms-docker/gh-pages
    targetRevision: 1.4.0
    chart: plex-media-server
    helm:
      valuesObject:
        ingress:
          enabled: false
        pms:
          storageClassName: ceph-block
          configStorage: 10Gi
        service:
          type: LoadBalancer
          port: 32400
          targetPort: 32400
          externalTrafficPolicy: Local
        extraEnv:
          TZ: "Etc/UTC"
          PLEX_UID: "1000"
          PLEX_GID: "10"
          UMASK: "022"
          # PLEX_CLAIM: "claim-xxx-first-time-use"
        extraVolumes:
          - name: nas-media-volume
            persistentVolumeClaim:
              claimName: plex-media-pvc
            # nfs:
            #   server: 172.16.10.2
            #   path: /volume1/media
          - name: node-exporter-textfiles
            hostPath:
              path: /var/lib/node_exporter/custom_metrics 
              type: DirectoryOrCreate
        extraVolumeMounts:
          - name: nas-media-volume
            mountPath: "/data/videos"
            readOnly: true
        extraContainers:
          - name: permission-checker
            image: alpine:latest
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              allowPrivilegeEscalation: false
            command: ["/bin/sh", "-c"]
            args:
              - |
                while true; do
                  # 1. Perform the deep scan. 
                  # We look for ANY file with 000 permissions.
                  # Using -print -quit makes it stop the moment it finds the FIRST broken file.
                  if find /data/Movies "/data/TV Shows" -perm 000 -type f -print -quit | grep -q .; then
                    echo "plex_nfs_permission_ok 0" > /node-metrics/plex_status.prom
                    echo "Alert: Found files with 000 permissions."
                  else
                    echo "plex_nfs_permission_ok 1" > /node-metrics/plex_status.prom
                  fi

                  # 2. Update timestamp so Prometheus knows the metric is fresh
                  echo "plex_nfs_last_check_timestamp $(date +%s)" >> /node-metrics/plex_status.prom
                  
                  chmod 644 /node-metrics/plex_status.prom

                  # 3. Wait for 1 hour
                  sleep 3600
                done
            volumeMounts:
              - name: nas-media-volume
                mountPath: /data
                readOnly: true
              - name: node-exporter-textfiles
                mountPath: /node-metrics