apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: plex
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/compare-options: ServerSideDiff=true
spec:
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      name: plex-plex-media-server
      jsonPointers:
      - /spec/template/metadata/creationTimestamp # Ignored for Pod Template
      - /metadata/creationTimestamp # Ignored for the StatefulSet itself
      - /spec/volumeClaimTemplates/0/metadata/creationTimestamp
  syncPolicy:
    automated:
      prune: true
      enabled: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
  destination:
    namespace: plex
    server: https://kubernetes.default.svc
  project: default
  source:
    repoURL: https://raw.githubusercontent.com/plexinc/pms-docker/gh-pages
    targetRevision: 1.4.0
    chart: plex-media-server
    helm:
      valuesObject:
        ingress:
          enabled: false
        pms:
          storageClassName: ceph-block
          configStorage: 10Gi
        service:
          type: LoadBalancer
          port: 32400
          targetPort: 32400
          externalTrafficPolicy: Local
          annotations:
            tailscale.com/expose: "true"
        extraEnv:
          TZ: "Etc/UTC"
          PLEX_UID: "1000"
          PLEX_GID: "1000"
          # PLEX_CLAIM: "claim-xxx-first-time-use"
        extraVolumes:
          - name: nas-media-volume
            hostPath:
              path: "/mnt/ugreen-media" 
              type: DirectoryOrCreate
        extraVolumeMounts:
          - name: nas-media-volume
            mountPath: "/data/videos"