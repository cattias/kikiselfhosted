apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: plex
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/compare-options: ServerSideDiff=true
spec:
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      name: plex-plex-media-server
      jsonPointers:
      - /spec/template/metadata/creationTimestamp # Ignored for Pod Template
      - /metadata/creationTimestamp # Ignored for the StatefulSet itself
      - /spec/volumeClaimTemplates/0/metadata/creationTimestamp
  syncPolicy:
    automated:
      prune: true
      enabled: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
  destination:
    namespace: plex
    server: https://kubernetes.default.svc
  project: default
  source:
    repoURL: https://raw.githubusercontent.com/plexinc/pms-docker/gh-pages
    targetRevision: 1.4.0
    chart: plex-media-server
    helm:
      valuesObject:
        ingress:
          enabled: false
        pms:
          storageClassName: ceph-block
          configStorage: 10Gi
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  # Search for any file with 000 permissions in /data/videos/Movies. 
                  # If the output of find is NOT empty, we exit with 1 (triggering a restart).
                  if [ -n "$(find /data/videos/Movies -maxdepth 2 -perm 000 -type f -print -quit)" ]; then
                    echo "Stale mount or 000 permission detected!"
                    exit 1
                  else
                    if [ -n "$(find '/data/videos/TV Shows' -maxdepth 2 -perm 000 -type f -print -quit)" ]; then
                      echo "Stale mount or 000 permission detected!"
                      exit 1
                    else
                      exit 0
                    fi
                  fi
            initialDelaySeconds: 60  # Give Plex time to start and mount the share
            periodSeconds: 300       # Check every 5 minutes
            failureThreshold: 1      # Require 1 consecutive failures before restarting
            timeoutSeconds: 30       # NFS lookups can be slow if the mount is hanging
        service:
          type: LoadBalancer
          port: 32400
          targetPort: 32400
          externalTrafficPolicy: Local
        extraEnv:
          TZ: "Etc/UTC"
          PLEX_UID: "1000"
          PLEX_GID: "10"
          UMASK: "022"
          # PLEX_CLAIM: "claim-xxx-first-time-use"
        extraVolumes:
          - name: nas-media-volume
            hostPath:
              path: "/mnt/ugreen-media" 
              type: DirectoryOrCreate
        extraVolumeMounts:
          - name: nas-media-volume
            mountPath: "/data/videos"