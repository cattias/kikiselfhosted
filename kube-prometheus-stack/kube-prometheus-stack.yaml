apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  syncPolicy:
    automated:
      enabled: true
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts/
    targetRevision: 80.0.0
    helm:
      releaseName: kube-prometheus-stack
      valuesObject:
        grafana:
          enabled: false
        prometheus:
          prometheusSpec:
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: ceph-block
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 50Gi
        alertmanager:
          alertmanagerSpec:
            externalUrl: https://alertmanager.attias.io
            secrets:
              - telegram-bot-secret
          config:
            global:
              resolve_timeout: 5m
            inhibit_rules:
              - source_matchers:
                  - 'severity = critical'
                target_matchers:
                  - 'severity =~ warning|info'
                equal:
                  - 'namespace'
                  - 'alertname'
              - source_matchers:
                  - 'severity = warning'
                target_matchers:
                  - 'severity = info'
                equal:
                  - 'namespace'
                  - 'alertname'
              - source_matchers:
                  - 'alertname = InfoInhibitor'
                target_matchers:
                  - 'severity = info'
                equal:
                  - 'namespace'
              - target_matchers:
                  - 'alertname = InfoInhibitor'
            route:
              group_by: ['namespace']
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 1h
              receiver: 'telegram-alert'
              routes:
              - receiver: 'null'
                matchers:
                  - alertname = "Watchdog"
              - receiver: 'null'
                matchers:
                  - alertname = "KubeControllerManagerDown"
                  - job = "kube-controller-manager"
              - receiver: 'null'
                matchers:
                  - alertname = "KubeSchedulerDown"
                  - job = "kube-scheduler"
            receivers:
            - name: 'null'
            - name: 'telegram-alert'
              telegram_configs:
              - api_url: 'https://api.telegram.org'
                bot_token_file: '/etc/alertmanager/secrets/telegram-bot-secret/botid'
                chat_id: -5088656987
                parse_mode: 'MarkdownV2'
                message: '{{ template "telegram.kiki.message" .}}'
            templates:
            - '/etc/alertmanager/config/*.tmpl'
          templateFiles:
            telegram.tmpl: |-
              {{ define "telegram.kiki.message" }}
              {{printf "1ï¸âƒ£ __KikiServer__:\n"}}
              {{- if eq .Status "firing" -}}
              Alert: {{ .CommonLabels.alertname }}
              Status: ðŸ”¥ FIRING
              Severity: {{ if eq .CommonLabels.severity "critical" }}ðŸ”´ {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}ðŸŸ  {{ .CommonLabels.severity | title }}{{ else }}âšªï¸ {{ .CommonLabels.severity | title }}{{ end }}
              {{- else if eq .Status "resolved" -}}
                  âšªï¸ Alert: {{ .CommonLabels.alertname }}
              Status: âœ… RESOLVED
              Severity: {{ if eq .CommonLabels.severity "critical" }}ðŸŸ¢ {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}ðŸŸ¢ {{ .CommonLabels.severity | title }}{{ else }}âšªï¸ {{ .CommonLabels.severity | title }}{{ end }}
              {{- end }}

              {{- range .Alerts -}}

              {{- if .Labels.job }}
              Job: `{{ .Labels.job }}`
              {{- end }}

              {{- if .Labels.namespace }}
              Namespace: `{{ .Labels.namespace }}`
              {{- end }}

              {{- if .Labels.instance }}
              Instance: `{{ .Labels.instance }}`
              {{- end }}

              {{- if .Annotations.runbook_url }}
              [RunbookURL]({{ .Annotations.runbook_url }})

              {{- end }}
              {{- end }}
              {{ end }}
        prometheus-node-exporter:
          serviceAccount:
            automountServiceAccountToken: true
            create: true
          sidecars:
            - name: version-checker
              image: alpine/curl:latest
              # Arguments to run the script every 6 hours
              args:
              - /bin/sh
              - -c
              - |
                # --- 1. Set up Environment Variables for Internal API Access ---
                curl -L -o /opt/kubectl "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
                chmod +x /opt/kubectl

                export TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
                export API_SERVER="https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}"
                export CA=$(cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt | base64)

                KUBECONFIG_PATH="/opt/config"

                cat > $KUBECONFIG_PATH <<EOF
                apiVersion: v1
                kind: Config
                clusters:
                - cluster:
                    certificate-authority-data: $CA
                    server: $API_SERVER
                  name: kubernetes
                contexts:
                - context:
                    cluster: kubernetes
                    user: read-only-user
                  name: read-only-context
                current-context: read-only-context
                users:
                - name: read-only-user
                  user:
                    token: $TOKEN
                EOF

                export KUBECONFIG=$KUBECONFIG_PATH

                # --- 2. Execution Loop ---
                chmod +x /opt/version-check.sh
                # Run the script immediately, then loop every 6 hours
                /opt/version-check.sh
                while true; do
                  /opt/version-check.sh
                  sleep 6h
                done
          extraVolumes: # Add the volume that mounts the script from the ConfigMap
            - name: version-check-script-volume
              configMap:
                name: version-check-script
                defaultMode: 0755 # Ensure script is executable
                items:
                  - key: version-check.sh
                    path: version-check.sh
          sidecarVolumeMount: # Mount the script into the Sidecar container
            - name: version-check-script-volume-mount
              mountPath: /opt
              subPath: version-check.sh
            - name: textfilecollector
              mountPath: /var/lib/node_exporter/custom_metrics # Must match where script writes