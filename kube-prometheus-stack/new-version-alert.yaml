apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: version-upgrade-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: version.alerts
    interval: 1m
    rules:
    # 1. K0S UPGRADE ALERT
    - alert: K0sUpgradeAvailable
      # Fires when the sidecar script sets the metric value to 1 (True)
      expr: k0s_upgrade_available == 1 
      for: 5m # Wait 5 minutes to confirm the version check is stable
      labels:
        severity: warning
        tier: infrastructure
      annotations:
        summary: "K0s Upgrade Available ({{ $labels.current_version }} -> {{ $labels.latest_version }})"
        description: >
          A newer stable version of k0s is available. Current: {{ $labels.current_version }}, Latest: {{ $labels.latest_version }}.
          Action required: Check release notes and schedule an upgrade.

    # 2. ARGOCD UPGRADE ALERT
    - alert: ArgoCDUpgradeAvailable
      # Fires when the sidecar script sets the metric value to 1 (True)
      expr: argocd_upgrade_available == 1
      for: 5m
      labels:
        severity: warning
        tier: application
      annotations:
        summary: "ArgoCD Upgrade Available ({{ $labels.current_version }} -> {{ $labels.latest_version }})"
        description: >
          A newer stable version of ArgoCD is available. Current: {{ $labels.current_version }}, Latest: {{ $labels.latest_version }}.
          Action required: Update Helm values for ArgoCD deployment.